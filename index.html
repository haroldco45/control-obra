<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Auditor√≠a Paralela - Vibras Positivas</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.2/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --negro: #1a1a1a; --oro: #f1c40f; --gris: #f4f7f6; --rojo: #e74c3c; --azul: #3498db; --verde: #27ae60; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--gris); margin: 0; padding-bottom: 60px; }
        header { background: var(--negro); color: var(--oro); padding: 15px; text-align: center; border-bottom: 5px solid var(--oro); }
        .container { padding: 15px; max-width: 650px; margin: auto; }
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-top: 4px solid var(--oro); }
        
        /* Alerta de Backup */
        #alerta-backup { background: #fff3cd; color: #856404; padding: 10px; border-radius: 8px; margin-bottom: 15px; display: none; border: 1px solid #ffeeba; font-size: 12px; font-weight: bold; text-align: center; }

        .tab-bar { display: flex; background: #ddd; margin-bottom: 15px; border-radius: 8px; overflow: hidden; }
        .tab-btn { flex: 1; padding: 12px; border: none; cursor: pointer; font-weight: bold; font-size: 11px; }
        .tab-btn.active { background: var(--oro); color: var(--negro); }
        input, select { width: 100%; padding: 10px; margin: 5px 0; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; }
        .item-row { display: grid; grid-template-columns: 2fr 1fr; gap: 8px; margin-bottom: 8px; }
        .btn-main { background: var(--negro); color: var(--oro); border: none; padding: 15px; border-radius: 10px; width: 100%; font-size: 16px; font-weight: bold; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 10px; }
        th, td { border: 1px solid #eee; padding: 8px; text-align: left; }
        .btn-del { color: var(--rojo); font-weight: bold; cursor: pointer; border: none; background: none; }
        .btn-edit { color: var(--azul); font-weight: bold; cursor: pointer; border: none; background: none; margin-right: 10px; }
        footer { text-align: center; font-size: 10px; color: #777; padding: 20px; }
    </style>
</head>
<body onload="initApp()">

<header>
    <div style="font-size: 9px; letter-spacing: 2px;">‚ú® VIBRAS POSITIVAS ‚ú®</div>
    <strong>LOG√çSTICA AUDITABLE PARALELA</strong>
</header>

<div class="container">
    <div id="alerta-backup">
        ‚è≥ Toca aqu√≠ para enviar el Backup de las 2 horas al Ingeniero.
        <button onclick="enviarBackupAutomatico()" style="margin-top:5px; background:var(--azul); color:white; border:none; padding:5px; border-radius:5px;">ENVIAR AHORA</button>
    </div>

    <div class="tab-bar">
        <button class="tab-btn active" onclick="verTab('movimiento')">REGISTRAR</button>
        <button class="tab-btn" onclick="verTab('inventario')">üì¶ EXISTENCIAS</button>
        <button class="tab-btn" onclick="verTab('informes')">üìä HISTORIAL / BACKUP</button>
    </div>

    <div id="movimiento" class="tab-content">
        <div class="card">
            <h3>üìù Registro de Bodega</h3>
            <input type="text" id="bodeguero" placeholder="Bodeguero (Entrega)">
            <input type="text" id="receptor" placeholder="Receptor (Recibe)">
            <select id="tipo_mov">
                <option value="SALIDA">üî¥ SALIDA / CONSUMO</option>
                <option value="DEVOLUCION">üü¢ DEVOLUCI√ìN</option>
                <option value="PRESTAMO">üõ†Ô∏è PR√âSTAMO</option>
            </select>
            <div id="lista-mov">
                <div class="item-row">
                    <input type="text" class="m-art" placeholder="Producto" list="lista-productos">
                    <input type="number" class="m-can" placeholder="Cant.">
                </div>
            </div>
            <button onclick="addFilaMov()" style="width:100%; border:1px dashed #ccc; padding:8px; margin-top:5px; cursor:pointer">+ OTRO √çTEM</button>
        </div>
        <button class="btn-main" onclick="procesarMovimiento()">üíæ REGISTRAR</button>
    </div>

    <div id="inventario" class="tab-content" style="display:none;">
        <div class="card">
            <h3>üì¶ Inventario en Vivo</h3>
            <table>
                <thead><tr><th>Producto</th><th>Saldo</th><th>Acci√≥n</th></tr></thead>
                <tbody id="cuerpo-saldos"></tbody>
            </table>
            <button class="btn-main" style="margin-top:15px; background:var(--verde);" onclick="addItemManual()">+ NUEVO PRODUCTO</button>
        </div>
    </div>

    <div id="informes" class="tab-content" style="display:none;">
        <div class="card">
            <h3>üìä Historial de Movimientos</h3>
            <div style="overflow-x:auto;">
                <table>
                    <thead><tr><th>Fecha</th><th>Producto</th><th>Cant.</th><th>Acci√≥n</th></tr></thead>
                    <tbody id="cuerpo-logs"></tbody>
                </table>
            </div>
            <button class="btn-main" style="margin-top:15px; background:var(--verde);" onclick="exportarExcel()">üì• EXCEL</button>
        </div>

        <div class="card">
            <h3>üíæ Sincronizaci√≥n Manual (Backup)</h3>
            <button class="btn-main" style="background:var(--azul); font-size:12px;" onclick="enviarBackupAutomatico()">üì§ ENVIAR RESPALDO POR WHATSAPP</button>
            <button class="btn-main" style="background:#666; font-size:12px; margin-top:10px;" onclick="restaurarBackup()">üì• RESTAURAR DATOS EN ESTE EQUIPO</button>
        </div>
    </div>
</div>

<datalist id="lista-productos"></datalist>

<script>
    let inventory = JSON.parse(localStorage.getItem('vp_inv_v6') || "[]");
    let logs = JSON.parse(localStorage.getItem('vp_logs_v6') || "[]");

    function initApp() {
        actualizarTablas();
        if(localStorage.getItem('last_bod')) document.getElementById('bodeguero').value = localStorage.getItem('last_bod');
        
        // Iniciar temporizador de 2 horas (7200000 ms)
        setInterval(mostrarAlertaBackup, 7200000); 
    }

    function mostrarAlertaBackup() {
        document.getElementById('alerta-backup').style.display = 'block';
    }

    function verTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).style.display = 'block';
        event.currentTarget.classList.add('active');
        actualizarTablas();
    }

    function addFilaMov() {
        const div = document.createElement('div');
        div.className = 'item-row';
        div.innerHTML = `<input type="text" class="m-art" placeholder="Producto" list="lista-productos"><input type="number" class="m-can" placeholder="Cant.">`;
        document.getElementById('lista-mov').appendChild(div);
    }

    function actualizarTablas() {
        const cSaldos = document.getElementById('cuerpo-saldos');
        const dList = document.getElementById('lista-productos');
        cSaldos.innerHTML = ""; dList.innerHTML = "";
        inventory.sort((a,b) => a.nombre.localeCompare(b.nombre)).forEach((item, index) => {
            cSaldos.innerHTML += `<tr><td>${item.nombre}</td><td><strong>${item.saldo}</strong></td><td><button class="btn-edit" onclick="editarArticulo(${index})">‚úèÔ∏è</button></td></tr>`;
            dList.innerHTML += `<option value="${item.nombre}">`;
        });
        const cLogs = document.getElementById('cuerpo-logs');
        cLogs.innerHTML = "";
        logs.forEach((l, index) => {
            cLogs.innerHTML += `<tr><td>${l.fecha.split(' ')[0]}</td><td>${l.producto}</td><td>${l.cantidad}</td><td><button class="btn-del" onclick="eliminarLog(${index})">‚ùå</button></td></tr>`;
        });
    }

    function editarArticulo(index) {
        const nuevoNombre = prompt("Nombre:", inventory[index].nombre);
        const nuevoSaldo = prompt("Saldo:", inventory[index].saldo);
        if(nuevoNombre && nuevoSaldo) {
            inventory[index].nombre = nuevoNombre.toUpperCase().trim();
            inventory[index].saldo = parseFloat(nuevoSaldo) || 0;
            save();
        }
    }

    function procesarMovimiento() {
        const b = document.getElementById('bodeguero').value;
        const r = document.getElementById('receptor').value;
        const tipo = document.getElementById('tipo_mov').value;
        const fecha = new Date().toLocaleString('es-CO');
        if(!b || !r) return alert("Indique responsables.");

        document.querySelectorAll('#lista-mov .item-row').forEach(row => {
            const nombreArt = row.querySelector('.m-art').value.toUpperCase().trim();
            const cant = parseFloat(row.querySelector('.m-can').value) || 0;
            if(nombreArt && cant > 0) {
                let item = inventory.find(i => i.nombre === nombreArt);
                if(!item) { item = { nombre: nombreArt, saldo: 0 }; inventory.push(item); }
                if(tipo === 'SALIDA' || tipo === 'PRESTAMO') item.saldo -= cant;
                else item.saldo += cant;
                logs.unshift({ fecha, tipo, entreg√≥: b, recibi√≥: r, producto: nombreArt, cantidad: cant });
            }
        });
        save();
        alert("Registrado.");
        location.reload();
    }

    function save() {
        localStorage.setItem('vp_inv_v6', JSON.stringify(inventory));
        localStorage.setItem('vp_logs_v6', JSON.stringify(logs));
        actualizarTablas();
    }

    // --- EL CONTROL PARALELO DEL INGENIERO ---
    function enviarBackupAutomatico() {
        const data = { inv: inventory, hist: logs };
        const backupString = JSON.stringify(data);
        
        // Mensaje para el Ingeniero
        const msg = `üõ°Ô∏è *BACKUP AUTOM√ÅTICO DE SEGURIDAD*\nüìÖ Fecha: ${new Date().toLocaleString()}\nüì¶ Estado: Sincronizaci√≥n Paralela\n--------------------------\nCopia este c√≥digo y √∫salo en tu App para ver el inventario real:\n\n${backupString}`;
        
        // Ocultar alerta
        document.getElementById('alerta-backup').style.display = 'none';
        
        // Enviar por WhatsApp al Ingeniero
        window.location.href = `https://wa.me/573117700431?text=${encodeURIComponent(msg)}`;
    }

    function restaurarBackup() {
        const json = prompt("INGENIERO: Pegue aqu√≠ el c√≥digo de backup enviado por WhatsApp:");
        if (!json) return;
        try {
            const data = JSON.parse(json);
            inventory = data.inv || [];
            logs = data.hist || [];
            save();
            alert("‚úÖ INGENIERO: Informaci√≥n sincronizada. Ahora tiene el control de la bodega en su celular.");
        } catch (e) { alert("Error en el formato del c√≥digo."); }
    }

    function exportarExcel() {
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(logs), "Historial");
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(inventory), "Saldos");
        XLSX.writeFile(wb, "Auditoria_VibrasPositivas.xlsx");
    }

    function addItemManual() {
        const n = prompt("Nombre:").toUpperCase();
        if(n) { inventory.push({nombre:n, saldo:0}); save(); }
    }
    function eliminarLog(idx) { if(confirm("Borrar?")) { logs.splice(idx, 1); save(); } }
</script>
</body>
</html>
