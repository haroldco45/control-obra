<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Auditor√≠a Almac√©n - Vibras Positivas</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.2/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --negro: #1a1a1a; --oro: #f1c40f; --gris: #f4f7f6; --success: #27ae60; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--gris); margin: 0; padding-bottom: 50px; }
        header { background: var(--negro); color: var(--oro); padding: 20px; text-align: center; border-bottom: 5px solid var(--oro); }
        .logo-v { font-size: 10px; letter-spacing: 3px; color: #fff; margin-bottom: 5px; }
        .container { padding: 15px; max-width: 600px; margin: auto; }
        .card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-top: 4px solid var(--oro); }
        h3 { margin-top: 0; font-size: 13px; text-transform: uppercase; border-bottom: 1px solid #eee; padding-bottom: 8px; color: #444; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; font-size: 14px; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .type-btn { padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 11px; cursor: pointer; background: #fff; text-align: center; }
        .type-btn.active { background: var(--oro); border-color: var(--oro); font-weight: bold; }
        .item-row { display: flex; gap: 8px; margin-bottom: 8px; }
        .btn-main { background: var(--negro); color: var(--oro); border: none; padding: 18px; border-radius: 12px; width: 100%; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-sec { background: #e0e0e0; color: #333; border: none; padding: 10px; border-radius: 8px; width: 100%; margin-top: 10px; cursor: pointer; }
        .informe-seccion { display: none; }
        table { width: 100%; border-collapse: collapse; font-size: 10px; background: white; }
        th, td { border: 1px solid #ddd; padding: 6px; text-align: left; }
        canvas { border: 2px dashed #ccc; border-radius: 8px; width: 100%; height: 100px; background: #fafafa; }
        footer { text-align: center; font-size: 11px; color: #777; padding: 20px; }
    </style>
</head>
<body onload="initApp()">

<header>
    <div class="logo-v">‚ú® VIBRAS POSITIVAS ‚ú®</div>
    <strong>LOG√çSTICA Y AUDITOR√çA</strong>
    <div id="fecha-col" style="font-size: 12px; color: #fff; margin-top: 5px;">Cargando hora de Colombia...</div>
</header>

<div class="container" id="vista-registro">
    <div class="card">
        <h3>üë∑ Control de Personal</h3>
        <input type="text" id="entregado_por" placeholder="üì¶ Entregado por (Bodeguero)">
        <input type="text" id="recibido_por" placeholder="üë∑ Recibido por (Operario/Frente)">
        <input type="text" id="frente" placeholder="üìç Frente de Obra / Destino">
    </div>

    <div class="card">
        <h3>üîÑ Operaci√≥n de Almac√©n</h3>
        <div class="btn-group">
            <div class="type-btn active" onclick="setTipo(this, 'SALIDA')">SALIDA / CONSUMO</div>
            <div class="type-btn" onclick="setTipo(this, 'PRESTAMO')">PR√âSTAMO HERRAMIENTA</div>
            <div class="type-btn" onclick="setTipo(this, 'DEVOLUCION')">DEVOLUCI√ìN</div>
            <div class="type-btn" onclick="setTipo(this, 'AVERIA')">AVER√çA / DA√ëO</div>
        </div>
        <input type="hidden" id="tipo_mov" value="SALIDA">
    </div>

    <div class="card">
        <h3>üìã Materiales e Insumos</h3>
        <div id="lista-items">
            <div class="item-row">
                <input type="text" class="in-art" placeholder="Descripci√≥n">
                <input type="number" style="width:70px" class="in-can" placeholder="Cant.">
            </div>
        </div>
        <button class="btn-sec" onclick="addItem()">+ AGREGAR OTRO √çTEM</button>
    </div>

    <div class="card">
        <h3>‚úçÔ∏è Firma de Recibido</h3>
        <canvas id="signature-pad"></canvas>
    </div>

    <button class="btn-main" onclick="procesarRegistro()">üíæ REGISTRAR MOVIMIENTO</button>
    <button class="btn-sec" onclick="alternarVistas()">üìä CONSULTAR INFORMES</button>
</div>

<div class="container informe-seccion" id="vista-informes">
    <div class="card">
        <h3>üìä Historial de Auditor√≠a</h3>
        <div style="overflow-x: auto;">
            <table id="tabla-logs">
                <thead>
                    <tr>
                        <th>Fecha/Hora</th>
                        <th>Tipo</th>
                        <th>Entreg√≥</th>
                        <th>Recibi√≥</th>
                        <th>Detalle</th>
                    </tr>
                </thead>
                <tbody id="cuerpo-tabla"></tbody>
            </table>
        </div>
        <button class="btn-main" style="margin-top:20px; background: var(--success);" onclick="exportarExcel()">üì• DESCARGAR EXCEL</button>
        <button class="btn-sec" onclick="alternarVistas()">‚¨ÖÔ∏è VOLVER AL REGISTRO</button>
    </div>
</div>

<footer>
    VALE DE ALMAC√âN AUDITABLE <br>
    <strong>DESARROLLADO POR VIBRAS POSITIVAS</strong> ¬© 2026
</footer>

<script>
    let canvas, ctx, drawing = false;

    function initApp() {
        // Mostrar fecha real de Colombia
        actualizarReloj();
        setInterval(actualizarReloj, 1000);
        
        if(localStorage.getItem('bodeguero')) document.getElementById('entregado_por').value = localStorage.getItem('bodeguero');
        
        canvas = document.getElementById('signature-pad');
        ctx = canvas.getContext('2d');
        canvas.width = canvas.offsetWidth;
        setupCanvas();
    }

    function actualizarReloj() {
        const ahora = new Date();
        const opciones = { timeZone: 'America/Bogota', hour12: true, hour: '2-digit', minute: '2-digit', second: '2-digit', day: '2-digit', month: '2-digit', year: 'numeric' };
        document.getElementById('fecha-col').innerText = ahora.toLocaleString('es-CO', opciones);
    }

    function setupCanvas() {
        const getPos = (e) => {
            const rect = canvas.getBoundingClientRect();
            return { x: (e.clientX || (e.touches ? e.touches[0].clientX : 0)) - rect.left, 
                     y: (e.clientY || (e.touches ? e.touches[0].clientY : 0)) - rect.top };
        };
        const start = (e) => { drawing = true; ctx.beginPath(); const p = getPos(e); ctx.moveTo(p.x, p.y); };
        const move = (e) => { if(!drawing) return; const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); e.preventDefault(); };
        const stop = () => { drawing = false; };
        canvas.addEventListener('touchstart', start); canvas.addEventListener('touchmove', move); canvas.addEventListener('touchend', stop);
        canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', move); window.addEventListener('mouseup', stop);
    }

    function setTipo(btn, valor) {
        document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('tipo_mov').value = valor;
    }

    function addItem() {
        const div = document.createElement('div');
        div.className = 'item-row';
        div.innerHTML = `<input type="text" class="in-art" placeholder="Descripci√≥n"><input type="number" style="width:70px" class="in-can" placeholder="Cant.">`;
        document.getElementById('lista-items').appendChild(div);
    }

    function alternarVistas() {
        const reg = document.getElementById('vista-registro');
        const inf = document.getElementById('vista-informes');
        if(reg.style.display === "none") {
            reg.style.display = "block"; inf.style.display = "none";
        } else {
            reg.style.display = "none"; inf.style.display = "block";
            cargarTabla();
        }
    }

    function procesarRegistro() {
        const entrego = document.getElementById('entregado_por').value;
        const recibio = document.getElementById('recibido_por').value;
        const frente = document.getElementById('frente').value;
        const tipo = document.getElementById('tipo_mov').value;
        const fechaHora = document.getElementById('fecha-col').innerText;

        if(!entrego || !recibio || !frente) return alert("Error: Debe indicar qui√©n entrega, qui√©n recibe y el frente.");

        localStorage.setItem('bodeguero', entrego);

        let itemsText = "";
        let itemsArr = [];
        document.querySelectorAll('.item-row').forEach(row => {
            const a = row.querySelector('.in-art').value;
            const c = row.querySelector('.in-can').value;
            if(a) {
                itemsText += `‚Ä¢ ${a}: ${c}\n`;
                itemsArr.push(`${a}(${c})`);
            }
        });

        const log = {
            fecha: fechaHora,
            tipo: tipo,
            entrego: entrego,
            recibio: recibio,
            frente: frente,
            materiales: itemsArr.join(", ")
        };

        let db = JSON.parse(localStorage.getItem('audit_db_v2') || "[]");
        db.unshift(log);
        localStorage.setItem('audit_db_v2', JSON.stringify(db));

        const msg = `*üõ°Ô∏è VALE DE ALMAC√âN - VIBRAS POSITIVAS*\n` +
                    `üìÖ *FECHA:* ${fechaHora}\n` +
                    `üìë *TIPO:* ${tipo}\n` +
                    `üì¶ *ENTREG√ì:* ${entrego}\n` +
                    `üë∑ *RECIBI√ì:* ${recibio}\n` +
                    `üìç *FRENTE:* ${frente}\n` +
                    `---------------------------\n` +
                    `*MATERIALES:*\n${itemsText}\n` +
                    `---------------------------\n` +
                    `‚úÖ _Registro verificado por Auditor√≠a_`;

        window.location.href = `https://wa.me/573117700431?text=${encodeURIComponent(msg)}`;
    }

    function cargarTabla() {
        const db = JSON.parse(localStorage.getItem('audit_db_v2') || "[]");
        const cuerpo = document.getElementById('cuerpo-tabla');
        cuerpo.innerHTML = "";
        db.forEach(l => {
            cuerpo.innerHTML += `<tr><td>${l.fecha}</td><td>${l.tipo}</td><td>${l.entrego}</td><td>${l.recibio}</td><td>${l.materiales}</td></tr>`;
        });
    }

    function exportarExcel() {
        const db = JSON.parse(localStorage.getItem('audit_db_v2') || "[]");
        if(db.length === 0) return alert("No hay datos.");
        const ws = XLSX.utils.json_to_sheet(db);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "AuditoriaAlmacen");
        XLSX.writeFile(wb, "Reporte_Almacen_VibrasPositivas.xlsx");
    }
</script>
</body>
</html>
