<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Saldos de Almac√©n - Vibras Positivas</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.2/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --negro: #1a1a1a; --oro: #f1c40f; --gris: #f4f7f6; --rojo: #e74c3c; --verde: #27ae60; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--gris); margin: 0; padding-bottom: 60px; }
        header { background: var(--negro); color: var(--oro); padding: 15px; text-align: center; border-bottom: 5px solid var(--oro); position: sticky; top: 0; z-index: 100; }
        .container { padding: 15px; max-width: 650px; margin: auto; }
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-top: 4px solid var(--oro); }
        h3 { margin-top: 0; font-size: 13px; text-transform: uppercase; color: #444; display: flex; justify-content: space-between; }
        
        input, select { width: 100%; padding: 10px; margin: 5px 0; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; }
        
        .tab-bar { display: flex; background: #ddd; margin-bottom: 15px; border-radius: 8px; overflow: hidden; }
        .tab-btn { flex: 1; padding: 12px; border: none; cursor: pointer; font-weight: bold; font-size: 12px; }
        .tab-btn.active { background: var(--oro); color: var(--negro); }

        .item-row { display: grid; grid-template-columns: 2fr 1fr; gap: 8px; margin-bottom: 8px; }
        .btn-main { background: var(--negro); color: var(--oro); border: none; padding: 15px; border-radius: 10px; width: 100%; font-size: 16px; font-weight: bold; cursor: pointer; }
        
        /* Tabla de Saldos */
        .tabla-saldos { width: 100%; border-collapse: collapse; font-size: 12px; }
        .tabla-saldos th { background: #eee; padding: 8px; text-align: left; }
        .tabla-saldos td { padding: 8px; border-bottom: 1px solid #eee; }
        .stock-bajo { color: var(--rojo); font-weight: bold; }

        footer { text-align: center; font-size: 11px; color: #777; padding: 20px; }
    </style>
</head>
<body onload="initApp()">

<header>
    <div style="font-size: 9px; letter-spacing: 2px;">‚ú® VIBRAS POSITIVAS ‚ú®</div>
    <strong>GESTI√ìN DE SALDOS Y AUDITOR√çA</strong>
    <div id="reloj" style="font-size: 11px; margin-top: 5px;"></div>
</header>

<div class="container">
    <div class="tab-bar">
        <button class="tab-btn active" onclick="verTab('movimiento')">MOVIMIENTOS</button>
        <button class="tab-btn" onclick="verTab('inventario')">üì¶ SALDOS (EXISTENCIAS)</button>
        <button class="tab-btn" onclick="verTab('informes')">üìä INFORMES</button>
    </div>

    <div id="movimiento" class="tab-content">
        <div class="card">
            <h3>üë∑ Personal Responsable</h3>
            <input type="text" id="bodeguero" placeholder="Qui√©n Entrega (Bodeguero)">
            <input type="text" id="receptor" placeholder="Qui√©n Recibe (Operario)">
            <select id="tipo_mov">
                <option value="SALIDA">üî¥ SALIDA / CONSUMO (Resta)</option>
                <option value="DEVOLUCION">üü¢ DEVOLUCI√ìN (Suma)</option>
                <option value="PRESTAMO">üõ†Ô∏è PR√âSTAMO HERRAMIENTA</option>
                <option value="AVERIA">‚ö†Ô∏è AVER√çA / DA√ëO</option>
            </select>
        </div>
        <div class="card">
            <h3>üìã Detalles del Vale</h3>
            <div id="lista-mov">
                <div class="item-row">
                    <input type="text" class="m-art" placeholder="Producto" list="lista-productos">
                    <input type="number" class="m-can" placeholder="Cant.">
                </div>
            </div>
            <button onclick="addFilaMov()" style="width:100%; margin-top:5px; border:1px dashed #ccc; padding:5px; cursor:pointer">+ OTRO ITEM</button>
        </div>
        <button class="btn-main" onclick="procesarMovimiento()">üíæ REGISTRAR Y DESCONTAR</button>
    </div>

    <div id="inventario" class="tab-content" style="display:none;">
        <div class="card">
            <h3>üì• Carga de Mercanc√≠a Inicial</h3>
            <p style="font-size:11px; color:#666;">Use esta secci√≥n para recibir la bodega o cargar saldos nuevos.</p>
            <div id="lista-inv">
                <div class="item-row">
                    <input type="text" class="i-art" placeholder="Producto/Herramienta">
                    <input type="number" class="i-can" placeholder="Saldo Inicial">
                </div>
            </div>
            <button onclick="addFilaInv()" style="width:100%; margin-top:5px; border:1px dashed #ccc; padding:5px; cursor:pointer">+ CARGAR OTRO</button>
            <button class="btn-main" style="margin-top:15px; background:var(--verde);" onclick="cargarSaldos()">üì• ACTUALIZAR SALDOS</button>
        </div>

        <div class="card">
            <h3>üìà Existencias Actuales</h3>
            <table class="tabla-saldos">
                <thead><tr><th>Producto</th><th>Saldo Actual</th></tr></thead>
                <tbody id="cuerpo-saldos"></tbody>
            </table>
        </div>
    </div>

    <div id="informes" class="tab-content" style="display:none;">
        <div class="card">
            <h3>üìä Hist√≥rico de Auditor√≠a</h3>
            <div style="overflow-x:auto;">
                <table class="tabla-saldos" id="tabla-logs">
                    <thead><tr><th>Fecha</th><th>Tipo</th><th>Entreg√≥</th><th>Recibi√≥</th><th>Detalle</th></tr></thead>
                    <tbody id="cuerpo-logs"></tbody>
                </table>
            </div>
            <button class="btn-main" style="margin-top:15px; background:var(--verde);" onclick="exportarExcel()">üì• EXPORTAR EXCEL</button>
            <button class="btn-main" style="margin-top:5px; background:#666; font-size:12px;" onclick="borrarTodo()">üóëÔ∏è RESET TOTAL</button>
        </div>
    </div>
</div>

<datalist id="lista-productos"></datalist>

<footer>
    SISTEMA DE CONTROL DE SALDOS <br>
    <strong>VIBRAS POSITIVAS</strong> ¬© 2026
</footer>

<script>
    let inventory = JSON.parse(localStorage.getItem('vp_saldos') || "{}");
    let logs = JSON.parse(localStorage.getItem('vp_logs') || "[]");

    function initApp() {
        actualizarReloj();
        setInterval(actualizarReloj, 1000);
        actualizarVistaSaldos();
        cargarTablaLogs();
        if(localStorage.getItem('last_bodeguero')) document.getElementById('bodeguero').value = localStorage.getItem('last_bodeguero');
    }

    function actualizarReloj() {
        const opciones = { timeZone: 'America/Bogota', hour12: true, hour: '2-digit', minute: '2-digit', second: '2-digit', day: '2-digit', month: '2-digit', year: 'numeric' };
        document.getElementById('reloj').innerText = new Date().toLocaleString('es-CO', opciones);
    }

    function verTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).style.display = 'block';
        event.currentTarget.classList.add('active');
        if(id === 'inventario') actualizarVistaSaldos();
    }

    function addFilaMov() {
        const div = document.createElement('div');
        div.className = 'item-row';
        div.innerHTML = `<input type="text" class="m-art" placeholder="Producto" list="lista-productos"><input type="number" class="m-can" placeholder="Cant.">`;
        document.getElementById('lista-mov').appendChild(div);
    }

    function addFilaInv() {
        const div = document.createElement('div');
        div.className = 'item-row';
        div.innerHTML = `<input type="text" class="i-art" placeholder="Producto"><input type="number" class="i-can" placeholder="Saldo">`;
        document.getElementById('lista-inv').appendChild(div);
    }

    // CARGAR SALDOS INICIALES
    function cargarSaldos() {
        document.querySelectorAll('#lista-inv .item-row').forEach(row => {
            const art = row.querySelector('.i-art').value.trim().toUpperCase();
            const can = parseFloat(row.querySelector('.i-can').value) || 0;
            if(art) inventory[art] = (inventory[art] || 0) + can;
        });
        saveData();
        alert("Saldos actualizados correctamente.");
        row.querySelectorAll('input').forEach(i => i.value = ""); // Limpiar
    }

    // PROCESAR MOVIMIENTO (Resta o Suma)
    function procesarMovimiento() {
        const b = document.getElementById('bodeguero').value;
        const r = document.getElementById('receptor').value;
        const tipo = document.getElementById('tipo_mov').value;
        const fecha = document.getElementById('reloj').innerText;

        if(!b || !r) return alert("Faltan nombres de bodeguero o receptor.");

        let detalleMsg = "";
        let itemsArr = [];

        document.querySelectorAll('#lista-mov .item-row').forEach(row => {
            const art = row.querySelector('.m-art').value.trim().toUpperCase();
            const can = parseFloat(row.querySelector('.m-can').value) || 0;

            if(art && can > 0) {
                // L√≥gica de Saldos
                if(tipo === 'SALIDA' || tipo === 'PRESTAMO' || tipo === 'AVERIA') {
                    inventory[art] = (inventory[art] || 0) - can;
                } else if(tipo === 'DEVOLUCION') {
                    inventory[art] = (inventory[art] || 0) + can;
                }
                detalleMsg += `‚Ä¢ ${art}: ${can}\n`;
                itemsArr.push(`${art}(${can})`);
            }
        });

        if(itemsArr.length === 0) return alert("No hay art√≠culos v√°lidos.");

        const logEntry = { fecha, tipo, entrego: b, recibio: r, detalle: itemsArr.join(", ") };
        logs.unshift(logEntry);
        localStorage.setItem('last_bodeguero', b);
        saveData();

        const msg = `*üõ°Ô∏è AUDITOR√çA ALMAC√âN - VIBRAS POSITIVAS*\nüìÖ ${fecha}\nüìë MOVIMIENTO: ${tipo}\nüì¶ ENTREG√ì: ${b}\nüë∑ RECIBI√ì: ${r}\n---------------------------\n${detalleMsg}---------------------------\n‚úÖ Saldos actualizados en sistema.`;
        window.location.href = `https://wa.me/573117700431?text=${encodeURIComponent(msg)}`;
    }

    function saveData() {
        localStorage.setItem('vp_saldos', JSON.stringify(inventory));
        localStorage.setItem('vp_logs', JSON.stringify(logs));
        actualizarVistaSaldos();
    }

    function actualizarVistaSaldos() {
        const cuerpo = document.getElementById('cuerpo-saldos');
        const datalist = document.getElementById('lista-productos');
        cuerpo.innerHTML = "";
        datalist.innerHTML = "";
        
        for (let art in inventory) {
            const saldo = inventory[art];
            const clase = saldo <= 0 ? 'stock-bajo' : '';
            cuerpo.innerHTML += `<tr><td>${art}</td><td class="${clase}">${saldo}</td></tr>`;
            datalist.innerHTML += `<option value="${art}">`;
        }
    }

    function cargarTablaLogs() {
        const cuerpo = document.getElementById('cuerpo-logs');
        cuerpo.innerHTML = "";
        logs.forEach(l => {
            cuerpo.innerHTML += `<tr><td>${l.fecha}</td><td>${l.tipo}</td><td>${l.entrego}</td><td>${l.recibio}</td><td>${l.detalle}</td></tr>`;
        });
    }

    function exportarExcel() {
        const wsMov = XLSX.utils.json_to_sheet(logs);
        const wsSal = XLSX.utils.json_to_sheet(Object.keys(inventory).map(k => ({Producto: k, Saldo: inventory[k]})));
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, wsMov, "Historial_Movimientos");
        XLSX.utils.book_append_sheet(wb, wsSal, "Saldos_Actuales");
        XLSX.writeFile(wb, "Auditoria_Almacen_Completa.xlsx");
    }

    function borrarTodo() {
        if(confirm("¬øSeguro? Se borrar√°n todos los saldos e historial.")) {
            localStorage.clear();
            location.reload();
        }
    }
</script>
</body>
</html>
